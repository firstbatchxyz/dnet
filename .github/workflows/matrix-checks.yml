name: Matrix Checks
on:
  workflow_call:
    inputs:
      python_version:
        required: false
        type: string
    secrets:
      CI_SSH_KEY:
        required: true

jobs:
  matrix-checks:
    strategy:
      matrix:
        os: [ubuntu-latest, mac2.metal]
    runs-on: ${{ matrix.os }}

    env:
      PYTHONPATH: src
      PROJECT_ROOT: ${{ github.workspace }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Environment
        uses: ./.github/actions/setup-env
        with:
          python_version: ${{ inputs.python_version || '3.12' }}

      - name: Ensure compatible gRPC/protobuf versions
        if: ${{ matrix.os == 'mac2.metal' }}
        run: |
          uv pip install --upgrade "grpcio>=1.75.1" "protobuf>=6.31.1"

      - name: Ruff format check (style/format) via uvx
        run: make format

      - name: Ruff lint via uvx
        run: make lint

      - name: Run tests (pytest)
        if: ${{ matrix.os == 'mac2.metal' }}
        run: |
          make test || ([ $? -eq 5 ] && echo "No tests collected, continuing..." && exit 0 || exit $?)
